<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Sir Kothay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Poppins', sans-serif; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Fixed Bottom Navbar on Mobile, Top on Desktop -->
  <nav class="fixed bottom-0 left-0 right-0 md:top-0 md:bottom-auto z-50 bg-white/80 backdrop-blur-lg border-t md:border-b border-gray-200/50">
    <div class="max-w-5xl mx-auto">

      <!-- Desktop Navbar (Top) -->
      <div class="hidden md:flex items-center justify-between px-8 py-4">
        <!-- Logo -->
        <a href="../index.html" class="flex items-center gap-3">
          <img src="../static/images/nav-logo.png" class="h-10 rounded-lg shadow-md" alt="Logo" />
        </a>

        <!-- Desktop Links -->
        <div class="flex items-center gap-6 text-sm font-medium">
          <a href="home.html" class="text-gray-700" style="transition: color 0.2s;" onmouseover="this.style.color='#f68b1f'" onmouseout="this.style.color=''">Dashboard</a>
          <a href="profile.html" class="text-gray-700" style="transition: color 0.2s;" onmouseover="this.style.color='#f68b1f'" onmouseout="this.style.color=''">Profile</a>
          <a href="#" onclick="logout()" class="text-red-600 hover:text-red-700">Logout</a>
          <a href="https://github.com/UIU-Developers-Hub/Sir-Kothay" target="_blank" class="text-gray-600 hover:text-black">
            <i class="bi bi-github text-xl"></i>
          </a>
        </div>
      </div>

      <!-- Mobile Bottom Navbar -->
      <div class="md:hidden">
        <div class="flex items-center justify-around py-3 bg-white border-t border-gray-200">
          
          <!-- Dashboard -->
          <a href="home.html" class="flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition bg-orange-50" style="color: #f68b1f;">
            <i class="bi bi-speedometer2 text-2xl"></i>
            <span class="text-xs font-medium">Dashboard</span>
          </a>
          
          <!-- Profile -->
          <a href="profile.html" class="flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition hover:bg-orange-50" style="color: #4b5563;">
            <i class="bi bi-person-circle text-2xl"></i>
            <span class="text-xs font-medium">Profile</span>
          </a>
          
          <!-- Logout -->
          <a href="#" onclick="logout()" class="flex flex-col items-center gap-1 px-3 py-2 rounded-xl text-red-600 hover:bg-red-50 transition">
            <i class="bi bi-box-arrow-right text-2xl"></i>
            <span class="text-xs font-medium">Logout</span>
          </a>

          <!-- GitHub -->
          <a href="https://github.com/UIU-Developers-Hub/Sir-Kothay" target="_blank" class="flex flex-col items-center gap-1 px-3 py-2 rounded-xl text-gray-600 hover:text-black transition">
            <i class="bi bi-github text-2xl"></i>
            <span class="text-xs font-medium">GitHub</span>
          </a>

        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="pt-0 md:pt-24 pb-20 md:pb-0 min-h-screen">
<div class="bg-gray-100 relative pt-4 min-h-screen">
    <!-- Loading State -->
    <div id="loadingState" class="flex justify-center items-center min-h-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading dashboard...</p>
        </div>
    </div>

    <!-- Main Content (hidden until loaded) -->
    <div id="mainContent" class="hidden">
        <!-- Profile Section -->
        <section class="max-w-4xl mx-auto bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
            <div class="flex flex-col lg:flex-row items-center lg:space-x-8 space-y-6 lg:space-y-0">
                <!-- User Image -->
                <div class="relative group">
                    <img id="userImage" src="../static/images/image.png" alt="User Image"
                        class="w-28 h-28 lg:w-36 lg:h-36 rounded-xl object-cover border-4 border-white shadow-xl transition-transform group-hover:scale-105">
                    <div class="absolute inset-0 rounded-xl bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
                </div>

                <!-- User Info -->
                <div class="flex-1 text-center lg:text-left">
                    <h1 id="userName" class="text-2xl lg:text-3xl font-bold text-gray-800 mb-1">Loading...</h1>
                    <p id="userEmail" class="text-gray-600 text-sm lg:text-base mb-1"></p>
                    <p id="userPhone" class="text-gray-600 text-sm lg:text-base mb-1"></p>
                    <p id="userOrg" class="text-gray-600 text-sm lg:text-base mb-2"></p>
                </div>

                <!-- QR Code & Actions -->
                <div class="flex flex-col items-center space-y-4">
                    <div class="w-24 h-24 lg:w-32 lg:h-32 bg-white flex items-center justify-center rounded-lg shadow-md border">
                        <img id="qrCode" src="../static/images/logo_placeholder.jpg" alt="QR Code" class="w-full h-full rounded-lg">
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="qrActionBtn" onclick="handleQRAction()" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 shadow-md transition-all">Generate</button>
                        <button id="broadcastBtn" onclick="viewBroadcastPage()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 shadow-md transition-all">Broadcast</button>
                        <button onclick="openModal('addMessageModal')" class="sm:hidden bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-purple-700 shadow-md transition-all">Add Message</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Message Cards Section -->
        <section class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md mt-6 relative">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Your Messages</h2>
            <div id="messagesList">
                <p class="text-gray-500 text-center py-8">Loading messages...</p>
            </div>
            
            <!-- Floating Add Button -->
            <button onclick="openModal('addMessageModal')"
                class="hidden sm:block fixed bottom-8 right-8 bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-700 z-40">
                + Add Message
            </button>
        </section>
    </div>

    <!-- Modals -->
    <!-- Add Message Modal -->
    <div id="addMessageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Add Message</h2>
            <textarea id="newMessageText" placeholder="Type your message here..."
                class="w-full border p-2 rounded mb-3"></textarea>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 justify-end">
                <button type="button" onclick="closeModal('addMessageModal')"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                <button type="button" onclick="submitNewMessage()"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add</button>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="editMessageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Edit Message</h2>
            <textarea id="editMessageTextarea" placeholder="Type your message here..."
                class="w-full border p-2 rounded mb-3"></textarea>
            <input type="hidden" id="editMessageId">
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 justify-end">
                <button type="button" onclick="closeModal('editMessageModal')"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                <button type="button" onclick="submitEditMessage()"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Download Options</h2>
            <p class="mb-4">Choose what to download:</p>
            <div class="flex flex-col space-y-2">
                <button onclick="downloadQROnly()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-center">Download QR Code Only</button>
                <button onclick="downloadQRWithInfo()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-center">Download QR with User Info</button>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeModal('downloadModal')"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- API Config -->
<script src="../static/js/api-config.js"></script>

<script>
// Check if user is logged in
function checkAuth() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '../auth/login.html';
        return false;
    }
    return true;
}

// Logout function
function logout() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    window.location.href = '../auth/login.html';
}

// Load dashboard data
async function loadDashboard() {
    if (!checkAuth()) return;

    try {
        console.log('Loading dashboard...');
        console.log('Token:', localStorage.getItem('access_token') ? 'Present' : 'Missing');
        
        const response = await apiRequest(API_ENDPOINTS.USER_DETAILS);
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);

        if (response.ok) {
            // Update UI with user data
            document.getElementById('userName').textContent = data.user_username || 'User';
            document.getElementById('userEmail').textContent = data.user_email || '';
            document.getElementById('userPhone').textContent = data.phone_number || '';
            document.getElementById('userOrg').textContent = `Organization: ${data.organization || 'N/A'}`;
            
            if (data.profile_image) {
                document.getElementById('userImage').src = API_BASE_URL + data.profile_image;
            }

            // Store user slug for broadcast link
            userSlug = data.slug || data.user_username;

            // Show main content
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            // Load QR code and messages
            loadQRCode();
            loadMessages();
        } else {
            console.error('API Error:', data);
            throw new Error(data.detail || 'Failed to load dashboard');
        }
    } catch (error) {
        console.error('Dashboard Load Error:', error);
        alert('Failed to load dashboard. Please clear your browser cache and login again.\n\nSteps:\n1. Press F12\n2. Type: localStorage.clear()\n3. Refresh and login again');
        logout();
    }
}

// Load messages
async function loadMessages() {
    try {
        const response = await apiRequest(API_ENDPOINTS.MESSAGES);
        const data = await response.json();

        const messagesList = document.getElementById('messagesList');
        
        if (data && data.length > 0) {
            messagesList.innerHTML = data.map(msg => `
                <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 bg-gray-50 p-4 rounded-md shadow-sm mb-3">
                    <div class="flex-1 text-center sm:text-left">
                        <p class="text-gray-600 text-sm sm:text-base">${escapeHtml(msg.message)}</p>
                        <p class="text-xs text-gray-400 mt-1">${msg.active ? '<span class="text-green-600 font-semibold">Active</span>' : '<span class="text-gray-500">Inactive</span>'}</p>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button onclick="toggleMessageStatus(${msg.id})" class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">
                            ${msg.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button onclick="openEditModal(${msg.id}, '${escapeHtml(msg.message).replace(/'/g, "\\'")}' )" class="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600">
                            Edit
                        </button>
                        <button onclick="confirmDeleteMessage(${msg.id})" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `).join('');
        } else {
            messagesList.innerHTML = '<div class="text-center text-gray-600 py-4">You have no messages.</div>';
        }
    } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messagesList').innerHTML = '<p class="text-red-500 text-center py-8">Failed to load messages</p>';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Modal functions
function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

// QR Code functions
let qrCodeUrl = null;

async function loadQRCode() {
    try {
        const response = await apiRequest(`${API_BASE_URL}/api/qrcode/qrcodes/my_qrcode/`);
        const data = await response.json();

        if (response.ok && data.image) {
            qrCodeUrl = API_BASE_URL + data.image;
            document.getElementById('qrCode').src = qrCodeUrl;
            document.getElementById('qrActionBtn').textContent = 'Download';
            document.getElementById('qrActionBtn').onclick = () => openModal('downloadModal');
        }
    } catch (error) {
        console.log('No QR code found, user can generate one');
    }
}

async function handleQRAction() {
    const btnText = document.getElementById('qrActionBtn').textContent;
    
    if (btnText === 'Download') {
        openModal('downloadModal');
    } else {
        await generateQRCode();
    }
}

async function generateQRCode() {
    try {
        const btn = document.getElementById('qrActionBtn');
        btn.disabled = true;
        btn.textContent = 'Generating...';
        
        const response = await apiRequest(`${API_BASE_URL}/api/qrcode/qrcodes/generate/`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            alert('QR Code generated successfully!');
            loadQRCode();
        } else {
            alert(data.message || 'Failed to generate QR code');
            btn.disabled = false;
            btn.textContent = 'Generate';
        }
    } catch (error) {
        console.error('Error generating QR code:', error);
        alert('Failed to generate QR code');
        const btn = document.getElementById('qrActionBtn');
        btn.disabled = false;
        btn.textContent = 'Generate';
    }
}

function downloadQROnly() {
    if (qrCodeUrl) {
        const link = document.createElement('a');
        link.href = qrCodeUrl;
        link.download = 'my-qr-code.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeModal('downloadModal');
    }
}

function downloadQRWithInfo() {
    if (!qrCodeUrl) return;
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = 600;
    canvas.height = 800;
    
    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Gradient header
    const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
    gradient.addColorStop(0, '#f68b1f');
    gradient.addColorStop(1, '#f68b1f');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, 120);
    
    // User name
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 32px Poppins, Arial';
    ctx.textAlign = 'center';
    const userName = document.getElementById('userName').textContent;
    ctx.fillText(userName, canvas.width / 2, 70);
    
    // Load QR code image
    const qrImg = new Image();
    qrImg.crossOrigin = 'anonymous';
    qrImg.onload = function() {
        // Draw QR code
        const qrSize = 300;
        const qrX = (canvas.width - qrSize) / 2;
        const qrY = 150;
        ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
        
        // User info section
        ctx.fillStyle = '#333333';
        ctx.font = 'bold 20px Poppins, Arial';
        ctx.textAlign = 'left';
        
        const infoY = qrY + qrSize + 50;
        const infoX = 50;
        
        // Email
        ctx.fillText('Email:', infoX, infoY);
        ctx.font = '18px Poppins, Arial';
        ctx.fillStyle = '#666666';
        const email = document.getElementById('userEmail').textContent;
        ctx.fillText(email, infoX, infoY + 30);
        
        // Phone
        ctx.fillStyle = '#333333';
        ctx.font = 'bold 20px Poppins, Arial';
        ctx.fillText('Phone:', infoX, infoY + 70);
        ctx.font = '18px Poppins, Arial';
        ctx.fillStyle = '#666666';
        const phone = document.getElementById('userPhone').textContent;
        ctx.fillText(phone, infoX, infoY + 100);
        
        // Organization
        ctx.fillStyle = '#333333';
        ctx.font = 'bold 20px Poppins, Arial';
        const orgText = document.getElementById('userOrg').textContent;
        ctx.fillText(orgText, infoX, infoY + 140);
        
        // Footer
        ctx.fillStyle = '#f68b1f';
        ctx.font = 'bold 16px Poppins, Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Sir Kothay - Stay Connected', canvas.width / 2, canvas.height - 30);
        
        // Download
        canvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'qr-code-with-info.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            closeModal('downloadModal');
        });
    };
    qrImg.src = qrCodeUrl;
}

// Broadcast page function
let userSlug = null;

function viewBroadcastPage() {
    if (userSlug) {
        window.open(`../broadcast/message.html?user=${userSlug}`, '_blank');
    } else {
        alert('User slug not available');
    }
}

// Message functions
async function submitNewMessage() {
    const messageText = document.getElementById('newMessageText').value;
    if (messageText && messageText.trim()) {
        try {
            const response = await apiRequest(`${API_BASE_URL}/api/broadcast/messages/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: messageText.trim(),
                    active: false
                })
            });
            const data = await response.json();

            if (response.ok) {
                document.getElementById('newMessageText').value = '';
                closeModal('addMessageModal');
                alert('Message added successfully!');
                loadMessages();
            } else {
                const errors = Object.values(data).flat().join(', ');
                alert(errors || 'Failed to add message');
            }
        } catch (error) {
            console.error('Error adding message:', error);
            alert('Failed to add message');
        }
    } else {
        alert('Please enter a message');
    }
}

function openEditModal(id, message) {
    document.getElementById('editMessageId').value = id;
    document.getElementById('editMessageTextarea').value = message;
    openModal('editMessageModal');
}

async function submitEditMessage() {
    const id = document.getElementById('editMessageId').value;
    const newMessage = document.getElementById('editMessageTextarea').value;
    
    if (newMessage && newMessage.trim()) {
        try {
            const response = await apiRequest(`${API_BASE_URL}/api/broadcast/messages/${id}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: newMessage.trim()
                })
            });
            const data = await response.json();

            if (response.ok) {
                closeModal('editMessageModal');
                alert('Message updated successfully!');
                loadMessages();
            } else {
                const errors = Object.values(data).flat().join(', ');
                alert(errors || 'Failed to update message');
            }
        } catch (error) {
            console.error('Error updating message:', error);
            alert('Failed to update message');
        }
    } else {
        alert('Please enter a message');
    }
}

async function toggleMessageStatus(id) {
    try {
        const response = await apiRequest(`${API_BASE_URL}/api/broadcast/messages/${id}/set_active/`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            alert(data.message || 'Message status updated!');
            loadMessages();
        } else {
            alert(data.message || 'Failed to update message status');
        }
    } catch (error) {
        console.error('Error toggling message:', error);
        alert('Failed to update message status');
    }
}

function confirmDeleteMessage(id) {
    if (confirm('Are you sure you want to delete this message?')) {
        deleteMessage(id);
    }
}

async function deleteMessage(id) {
    try {
        const response = await apiRequest(`${API_BASE_URL}/api/broadcast/messages/${id}/`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Message deleted successfully!');
            loadMessages();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to delete message');
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        alert('Failed to delete message');
    }
}

// Load dashboard on page load
loadDashboard();
</script>

</div>
  </main>

  <footer class="py-12 px-6 mt-4 mb-20 md:mb-4 bg-gray-900 text-gray-300">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
        <div>
          <div class="flex items-center gap-3 mb-4">
            <img src="../static/images/nav-logo.png" class="h-10 rounded-lg" alt="Logo">
            <span class="text-2xl font-bold text-white">Sir Kothay?</span>
          </div>
          <p class="text-gray-400">Simple notes. Strong bonds.</p>
        </div>

        <div>
          <h4 class="font-semibold text-white mb-4">Quick Links</h4>
          <ul class="space-y-2 text-gray-400">
            <li><a href="home.html" class="hover:text-white transition">Dashboard</a></li>
            <li><a href="profile.html" class="hover:text-white transition">Profile</a></li>
            <li><a href="../about.html" class="hover:text-white transition">About Us</a></li>
          </ul>
        </div>

        <div>
          <h4 class="font-semibold text-white mb-4">Connect</h4>
          <div class="flex gap-4">
            <a href="https://github.com/UIU-Developers-Hub/Sir-Kothay" class="text-2xl hover:text-white transition">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://www.facebook.com/uiudevelopershub" class="text-2xl hover:text-white transition">
              <i class="bi bi-facebook"></i>
            </a>
          </div>
          <div class="flex items-center gap-2 mt-6 text-sm">
            <img src="https://github.com/UIU-Developers-Hub.png" class="h-8 w-8 rounded-full" alt="UIU Developers Hub">
            <span>© 2025 Sir Kothay. Made with ❤️ by <a href="https://github.com/UIU-Developers-Hub" style="color: #f68b1f;" class="hover:underline">UIU Developers Hub</a></span>
          </div>
        </div>
      </div>
    </div>
  </footer>

</body>
</html>
