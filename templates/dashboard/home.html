{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Sir Kothay{% endblock %}

{% block body %}
<div class="bg-gray-100 relative pt-4">

    <!-- Profile Section -->
    <section class="max-w-4xl mx-auto bg-gradient-to-r from-green-50 to-green-100 p-6 rounded-xl shadow-lg border border-gray-200">
        <div class="flex flex-col lg:flex-row items-center lg:space-x-8 space-y-6 lg:space-y-0">
            <!-- User Image -->
            <div class="relative group">
                {% if userd.get_image_url %}
                <img src="{{ userd.get_image_url }}" alt="User Image"
                    class="w-28 h-28 lg:w-36 lg:h-36 rounded-full object-cover border-4 border-white shadow-xl transition-transform group-hover:scale-105">
                {% else %}
                <img src="{% static 'images/image.png' %}" alt="User Image"
                    class="w-28 h-28 lg:w-36 lg:h-36 rounded-full object-cover border-4 border-white shadow-xl transition-transform group-hover:scale-105">
                {% endif %}
                <div class="absolute inset-0 rounded-full bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
            </div>

            <!-- User Info -->
            <div class="flex-1 text-center lg:text-left">
                <h1 class="text-2xl lg:text-3xl font-bold text-gray-800 mb-1">{{ username }}</h1>
                <p class="text-gray-600 text-sm lg:text-base mb-1">{{ userd.user.email }}</p>
                <p class="text-gray-600 text-sm lg:text-base mb-1">{{ userd.phone_number }}</p>
                <p class="text-gray-600 text-sm lg:text-base mb-2">Organization: {{ userd.organization }}</p>
                <p class="text-gray-700 text-sm lg:text-base italic">{{ userd.bio }}</p>
            </div>

            <!-- QR Code & Actions -->
            <div class="flex flex-col items-center space-y-4">
                <div class="w-24 h-24 lg:w-32 lg:h-32 bg-white flex items-center justify-center rounded-lg shadow-md border">
                    {% if qrcode %}
                    <img src="{{ qrcode.get_qr_url }}" alt="QR Code" class="w-full h-full rounded-lg">
                    {% else %}
                    <img src="{% static 'images/logo_placeholder.jpg' %}" alt="" class="w-full h-full rounded-lg">
                    {% endif %}
                </div>
                <div class="flex space-x-2">
                    {% if qrcode %}
                    <a href="{% url 'download_qr' %}"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 shadow-md transition-all">Download</a>
                    {% else %}
                    <a href="{% url 'generate_qr' %}"
                        class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 shadow-md transition-all">Generate</a>
                    {% endif %}
                    <a href="{% url 'show_broadcast_messages' userd.slug %}"
                        class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 shadow-md transition-all">Broadcast</a>
                    
                </div>
            </div>
        </div>
    </section>

    <!-- Message Cards Section -->
    <section class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md mt-6 relative">
        {% if messages %}
        {% for msg in messages %}
        <div
            class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 bg-gray-50 p-4 rounded-md shadow-sm mb-3">
            <div class="flex-1 text-center sm:text-left">
                <p class="text-gray-600 text-sm sm:text-base">{{ msg.message }}</p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <a href="{% url 'toggle_broadcast_message' msg.pk %}"
                    class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">
                    {{ msg.active|yesno:"Deactivate,Activate" }}
                </a>
                <button data-id="{{ msg.pk }}" data-message="{{ msg.message }}"
                    data-url="{% url 'update_broadcast_message' 0 %}" onclick="openEditModal(this)"
                    class="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600">
                    Edit
                </button>
                <a href="{% url 'delete_broadcast_message' msg.pk %}"
                    class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Delete</a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center text-gray-600 py-4">
            You have no messages.
        </div>
        {% endif %}
        <!-- Floating Add Button -->
        <button onclick="openModal('addMessageModal')"
            class="fixed bottom-4 right-4 sm:bottom-8 sm:right-8 bg-blue-600 text-white px-5 py-3 rounded-full shadow-lg hover:bg-blue-700">
            + Add Message
        </button>
    </section>

    <!-- Modals -->
    <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Edit Profile</h2>

            <form id="editProfileForm" method="POST" action="{% url 'user_details_update' %}"
                enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Profile Image Preview -->
                <div class="flex items-center space-x-4 mb-3">
                    <img id="profileImagePreview" class="w-16 h-16 rounded-full border object-cover"
                        src="{{ user.details.get_image_url|default:'/static/default-profile.png' }}"
                        alt="Profile Image">
                    <input type="file" id="profileImageInput" name="profile_image" accept="image/*" class="hidden"
                        onchange="previewProfileImage(event)">
                    <button type="button" onclick="document.getElementById('profileImageInput').click()"
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                        Change Image
                    </button>
                </div>

                <input type="text" name="username" placeholder="Username" value="{{ user.username }}"
                    class="w-full border p-2 rounded mb-3">
                <input type="email" name="email" placeholder="Email" value="{{ user.email }}"
                    class="w-full border p-2 rounded mb-3">
                <textarea name="bio" placeholder="Bio"
                    class="w-full border p-2 rounded mb-3">{{ user.details.bio }}</textarea>
                <input type="text" name="organization" placeholder="Organization"
                    value="{{ user.details.organization }}" class="w-full border p-2 rounded mb-3">
                <input type="text" name="designation" placeholder="Designation" value="{{ user.details.designation }}"
                    class="w-full border p-2 rounded mb-3">
                <input type="text" name="phone_number" placeholder="Phone Number"
                    value="{{ user.details.phone_number }}" class="w-full border p-2 rounded mb-3">

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 justify-end">
                    <button type="button" onclick="closeModal('editProfileModal')"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function previewProfileImage(event) {
            const reader = new FileReader();
            reader.onload = function () {
                document.getElementById('profileImagePreview').src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }
    </script>

    <div id="addMessageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Add Message</h2>

            <form method="POST" action="{% url 'add_broadcast_message' %}">
                {% csrf_token %}
                <textarea name="message" placeholder="Type your message here..."
                    class="w-full border p-2 rounded mb-3"></textarea>

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 justify-end">
                    <button type="button" onclick="closeModal('addMessageModal')"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit"
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div id="editMessageModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 sm:w-1/3">
            <h2 class="text-xl font-semibold mb-4">Edit Message</h2>

            <form id="editMessageForm" method="POST">
                {% csrf_token %}
                <textarea id="editMessageTextarea" name="message" placeholder="Type your message here..."
                    class="w-full border p-2 rounded mb-3"></textarea>

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 justify-end">
                    <button type="button" onclick="closeModal('editMessageModal')"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openEditModal(button) {
            let messageId = button.getAttribute("data-id");
            let messageText = button.getAttribute("data-message");
            let baseUrl = button.getAttribute("data-url");

            let updateUrl = baseUrl.replace("0", messageId);

            document.getElementById("editMessageForm").action = updateUrl;
            document.getElementById("editMessageTextarea").value = messageText;
            document.getElementById("editMessageModal").classList.remove("hidden");
        }

        function closeModal(id) {
            document.getElementById(id).classList.add("hidden");
        }
    </script>

    <script>
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>

{% endblock %}